%% spectrum_converter.m
%
% Base code for light spectrum conversion.
% 
% Functionality:
% - Load a light spectrum file (.txt, .csv, or .mat)
% - Automatically adjust to spectrum limits and resolution
% - Interpolate if necessary to 1 nm step
% - Calculate PF (Photon Flux), PPF (Photosynthetic Photon Flux), Radiant Power
% - Calculate Luminous Flux (lm)
% - Calculate conversion ratios between physical quantities
% - Plot relevant curves for visual analysis
%
% Requirements:
% - Spectrum file must contain columns: Wavelength (nm), SPD (a.u.), Radiant Power (mW)

clc;
clear;
close all;

% USER INPUT
% -------------------------------------------------------------------------------------

% Force to project root if inside core/
currentFolder = pwd;
[~, folderName] = fileparts(currentFolder);

if strcmp(folderName, 'core')
    cd('..'); % Go up one level (to project root)
end

% Define the filename and path manually
filename = 'blue_450nm_cree_xml2.txt';
filepath = 'sample_spectra/';          

fullfile_path = fullfile(filepath, filename);

% LOAD DATA
% -------------------------------------------------------------------------------------

% Read file according to format
[~,~,ext] = fileparts(filename);

if strcmp(ext, '.txt')
    fileID = fopen(fullfile_path, 'r');
    fgetl(fileID); % Ignore header
    temp = textscan(fileID, '%f%f%f', 'Delimiter', '\t');
    fclose(fileID);
    WL = temp{1}';
    SPD = temp{2}';
    Wrad = temp{3}' / 1000; % Convert mW to W

elseif strcmp(ext, '.mat')
    data = load(fullfile_path);
    fields = fieldnames(data);
    SPD_mat = data.(fields{1});
    WL = SPD_mat(:,1)';
    SPD = SPD_mat(:,2)';
    % Note: Wrad not available in .mat by default here

elseif strcmp(ext, '.csv')
    data = readtable(fullfile_path, 'HeaderLines', 1);
    WL = data.Var1';
    SPD = data.Var2';
    Wrad = data.Var3';

else
    error('Unsupported file format. Please use .txt, .csv or .mat files.');
end

% Define initial and final wavelength limits
Wa = min(WL);
Wb = max(WL);

% Calculate mean step (delta lambda)
if length(WL) > 1
    delta_lambda = mean(diff(WL));
else
    delta_lambda = NaN;
end

fprintf('Loaded spectrum from %.1f nm to %.1f nm with an average step of %.2f nm.\n', Wa, Wb, delta_lambda);

% INTERPOLATE DATA TO 1 NM STEP (Optional)
% -------------------------------------------------------------------------------------

WL_interp = Wa:1:Wb;
SPD_interp = interp1(WL, SPD, WL_interp, 'linear', 0);

% DEFINE CIE 1978 PHOTOPIC CURVE
% -------------------------------------------------------------------------------------

CIE78 = [... % 420 elements
    0,0,0,0,0.0002,0.00039556,0.0008,0.0015457,0.0028,0.0046562,...
    0.0074,0.011779,0.0175,0.022678,0.0273,0.032584,0.0379,0.042391,0.0468,0.052122,...
    0.06,0.072942,0.09098,0.11284,0.13902,0.16987,0.20802,0.25808,0.323,0.4054,...
    0.503,0.60811,0.71,0.7951,0.862,0.91505,0.954,0.98004,0.99495,1.0,...
    0.995,0.97875,0.952,0.91558,0.87,0.81623,0.757,0.69483,0.631,0.56654,...
    0.503,0.44172,0.381,0.32052,0.265,0.21702,0.175,0.13812,0.107,0.081652,...
    0.061,0.044327,0.032,0.023454,0.017,0.011872,0.00821,0.0057723,0.004102,0.0029291,...
    0.002091,0.0014822,0.001047,0.00074015,0.00052,0.00036093,0.0002492,0.00017231,0.00012,8.462e-05,...
    6e-05,4.2446e-05,3e-05,2.121e-05,1.4989e-05,1.0584e-05,7.4656e-06,5.2592e-06,3.7028e-06,2.6076e-06,...
    1.8365e-06,1.295e-06,9.1092e-07,6.3564e-07];

WL78 = 360:5:825;

% Interpolate LEF for new wavelength grid
LEF = zeros(1,length(WL_interp));
for i = 1:length(WL_interp)
    LEF(i) = interp1(WL78, CIE78, WL_interp(i), 'linear', 0);
end

% Generate PAR curve
PAR_curve = zeros(size(WL_interp));
for i = 1:length(WL_interp)
    if WL_interp(i) >= 400 && WL_interp(i) <= 700
        PAR_curve(i) = 1;
    else
        PAR_curve(i) = 0;
    end
end

% PLOT SPECTRUM
% -------------------------------------------------------------------------------------

figure;
hold on;
plot(WL_interp, SPD_interp, 'b-', 'LineWidth', 2);       % Light SPD
plot(WL_interp, LEF, '--k', 'LineWidth', 1);            % Human Eye Photopic Curve
plot(WL_interp, PAR_curve, '--', 'Color', [0 0.7 0], 'LineWidth', 1);  % PAR curve
ylim([0 1.2]);
xlim([Wa Wb]);
legend('Light SPD', 'Human Eye Photopic Curve', 'PAR Curve');
xlabel('Wavelength (nm)');
ylabel('Relative Intensity / Arbitrary Units');
title('Normalized Spectrum');
grid on;
hold off;

% CALCULATIONS
% -------------------------------------------------------------------------------------

% Constant for photon flux calculation (u mol/s)
ConstPP = (1e-3) / (6.02214076e23 * 2.998e8 * 6.62607015e-34);

% Find indices for 400-700 nm range (photosynthetic range)
ind_inf = find(WL_interp >= 400, 1, 'first');
ind_sup = find(WL_interp <= 700, 1, 'last');

% Photon Flux (PF): considering all wavelengths
PF = sum(WL_interp .* SPD_interp) * ConstPP;

% Photosynthetic Photon Flux (PPF): considering 400-700nm range
PPF = sum(WL_interp(ind_inf:ind_sup) .* SPD_interp(ind_inf:ind_sup)) * ConstPP;

% Luminous Flux (lm)
FL = 683 * sum(SPD_interp .* LEF);

% Radiant Power (W)
RadiantPower = sum(SPD_interp);

% Relations
FL_PF = FL / PF;
FL_PPF = FL / PPF;
FL_Wrad = FL / RadiantPower;
Wrad_PPF = RadiantPower / PPF;
Wrad_PF = RadiantPower / PF;
PF_PPF = PF / PPF;

% Absolute Values of the Measurement
Wrad_abs = sum(Wrad);                            % Total radiant power [W]
FL_abs = Wrad_abs * FL_Wrad;                     % Absolute luminous flux [lm]
PPF_abs = PPF * Wrad_PPF;                        % Absolute photosynthetic photon flux [µmol/s]
PF_abs = PF * Wrad_PF;                           % Absolute photon flux [µmol/s]

% Define the original wavelength domain of the CIE 1931 color matching functions
WL_xyz = 360:1:830;

% Load the x̄(λ), ȳ(λ), z̄(λ) curves from CIE1931
xbar = [0.000129900000000000	0.000145847000000000	0.000163802100000000	0.000184003700000000	0.000206690200000000	0.000232100000000000	0.000260728000000000	0.000293075000000000	0.000329388000000000	0.000369914000000000	0.000414900000000000	0.000464158700000000	0.000518986000000000	0.000581854000000000	0.000655234700000000	0.000741600000000000	0.000845029600000000	0.000964526800000000	0.00109494900000000	0.00123115400000000	0.00136800000000000	0.00150205000000000	0.00164232800000000	0.00180238200000000	0.00199575700000000	0.00223600000000000	0.00253538500000000	0.00289260300000000	0.00330082900000000	0.00375323600000000	0.00424300000000000	0.00476238900000000	0.00533004800000000	0.00597871200000000	0.00674111700000000	0.00765000000000000	0.00875137300000000	0.0100288800000000	0.0114217000000000	0.0128690100000000	0.0143100000000000	0.0157044300000000	0.0171474400000000	0.0187812200000000	0.0207480100000000	0.0231900000000000	0.0262073600000000	0.0297824800000000	0.0338809200000000	0.0384682400000000	0.0435100000000000	0.0489956000000000	0.0550226000000000	0.0617188000000000	0.0692120000000000	0.0776300000000000	0.0869581100000000	0.0971767200000000	0.108406300000000	0.120767200000000	0.134380000000000	0.149358200000000	0.165395700000000	0.181983100000000	0.198611000000000	0.214770000000000	0.230186800000000	0.244879700000000	0.258777300000000	0.271807900000000	0.283900000000000	0.294943800000000	0.304896500000000	0.313787300000000	0.321645400000000	0.328500000000000	0.334351300000000	0.339210100000000	0.343121300000000	0.346129600000000	0.348280000000000	0.349599900000000	0.350147400000000	0.350013000000000	0.349287000000000	0.348060000000000	0.346373300000000	0.344262400000000	0.341808800000000	0.339094100000000	0.336200000000000	0.333197700000000	0.330041100000000	0.326635700000000	0.322886800000000	0.318700000000000	0.314025100000000	0.308884000000000	0.303290400000000	0.297257900000000	0.290800000000000	0.283970100000000	0.276721400000000	0.268917800000000	0.260422700000000	0.251100000000000	0.240847500000000	0.229851200000000	0.218407200000000	0.206811500000000	0.195360000000000	0.184213600000000	0.173327300000000	0.162688100000000	0.152283300000000	0.142100000000000	0.132178600000000	0.122569600000000	0.113275200000000	0.104297900000000	0.0956400000000000	0.0872995500000000	0.0793080400000000	0.0717177600000000	0.0645809900000000	0.0579500100000000	0.0518621100000000	0.0462815200000000	0.0411508800000000	0.0364128300000000	0.0320100000000000	0.0279172000000000	0.0241444000000000	0.0206870000000000	0.0175404000000000	0.0147000000000000	0.0121617900000000	0.00991996000000000	0.00796724000000000	0.00629634600000000	0.00490000000000000	0.00377717300000000	0.00294532000000000	0.00242488000000000	0.00223629300000000	0.00240000000000000	0.00292552000000000	0.00383656000000000	0.00517484000000000	0.00698208000000000	0.00930000000000000	0.0121494900000000	0.0155358800000000	0.0194775200000000	0.0239927700000000	0.0291000000000000	0.0348148500000000	0.0411201600000000	0.0479850400000000	0.0553786100000000	0.0632700000000000	0.0716350100000000	0.0804622400000000	0.0897399600000000	0.0994564500000000	0.109600000000000	0.120167400000000	0.131114500000000	0.142367900000000	0.153854200000000	0.165500000000000	0.177257100000000	0.189140000000000	0.201169400000000	0.213365800000000	0.225749900000000	0.238320900000000	0.251066800000000	0.263992200000000	0.277101700000000	0.290400000000000	0.303891200000000	0.317572600000000	0.331438400000000	0.345482800000000	0.359700000000000	0.374083900000000	0.388639600000000	0.403378400000000	0.418311500000000	0.433449900000000	0.448795300000000	0.464336000000000	0.480064000000000	0.495971300000000	0.512050100000000	0.528295900000000	0.544691600000000	0.561209400000000	0.577821500000000	0.594500000000000	0.611220900000000	0.627975800000000	0.644760200000000	0.661569700000000	0.678400000000000	0.695239200000000	0.712058600000000	0.728828400000000	0.745518800000000	0.762100000000000	0.778543200000000	0.794825600000000	0.810926400000000	0.826824800000000	0.842500000000000	0.857932500000000	0.873081600000000	0.887894400000000	0.902318100000000	0.916300000000000	0.929799500000000	0.942798400000000	0.955277600000000	0.967217900000000	0.978600000000000	0.989385600000000	0.999548800000000	1.00908920000000	1.01800640000000	1.02630000000000	1.03398270000000	1.04098600000000	1.04718800000000	1.05246670000000	1.05670000000000	1.05979440000000	1.06179920000000	1.06280680000000	1.06290960000000	1.06220000000000	1.06073520000000	1.05844360000000	1.05522440000000	1.05097680000000	1.04560000000000	1.03903690000000	1.03136080000000	1.02266620000000	1.01304770000000	1.00260000000000	0.991367500000000	0.979331400000000	0.966491600000000	0.952847900000000	0.938400000000000	0.923194000000000	0.907244000000000	0.890502000000000	0.872920000000000	0.854449900000000	0.835084000000000	0.814946000000000	0.794186000000000	0.772954000000000	0.751400000000000	0.729583600000000	0.707588800000000	0.685602200000000	0.663810400000000	0.642400000000000	0.621514900000000	0.601113800000000	0.581105200000000	0.561397700000000	0.541900000000000	0.522599500000000	0.503546400000000	0.484743600000000	0.466193900000000	0.447900000000000	0.429861300000000	0.412098000000000	0.394644000000000	0.377533300000000	0.360800000000000	0.344456300000000	0.328516800000000	0.313019200000000	0.298001100000000	0.283500000000000	0.269544800000000	0.256118400000000	0.243189600000000	0.230727200000000	0.218700000000000	0.207097100000000	0.195923200000000	0.185170800000000	0.174832300000000	0.164900000000000	0.155366700000000	0.146230000000000	0.137490000000000	0.129146700000000	0.121200000000000	0.113639700000000	0.106465000000000	0.0996904400000000	0.0933306100000000	0.0874000000000000	0.0819009600000000	0.0768042800000000	0.0720771200000000	0.0676866400000000	0.0636000000000000	0.0598068500000000	0.0562821600000000	0.0529710400000000	0.0498186100000000	0.0467700000000000	0.0437840500000000	0.0408753600000000	0.0380726400000000	0.0354046100000000	0.0329000000000000	0.0305641900000000	0.0283805600000000	0.0263448400000000	0.0244527500000000	0.0227000000000000	0.0210842900000000	0.0195998800000000	0.0182373200000000	0.0169871700000000	0.0158400000000000	0.0147906400000000	0.0138313200000000	0.0129486800000000	0.0121292000000000	0.0113591600000000	0.0106293500000000	0.00993884600000000	0.00928842200000000	0.00867885400000000	0.00811091600000000	0.00758238800000000	0.00708874600000000	0.00662731300000000	0.00619540800000000	0.00579034600000000	0.00540982600000000	0.00505258300000000	0.00471751200000000	0.00440350700000000	0.00410945700000000	0.00383391300000000	0.00357574800000000	0.00333434200000000	0.00310907500000000	0.00289932700000000	0.00270434800000000	0.00252302000000000	0.00235416800000000	0.00219661600000000	0.00204919000000000	0.00191096000000000	0.00178143800000000	0.00166011000000000	0.00154645900000000	0.00143997100000000	0.00134004200000000	0.00124627500000000	0.00115847100000000	0.00107643000000000	0.000999949300000000	0.000928735800000000	0.000862433200000000	0.000800750300000000	0.000743396000000000	0.000690078600000000	0.000640515600000000	0.000594502100000000	0.000551864600000000	0.000512429000000000	0.000476021300000000	0.000442453600000000	0.000411511700000000	0.000382981400000000	0.000356649100000000	0.000332301100000000	0.000309758600000000	0.000288887100000000	0.000269539400000000	0.000251568200000000	0.000234826100000000	0.000219171000000000	0.000204525800000000	0.000190840500000000	0.000178065400000000	0.000166150500000000	0.000155023600000000	0.000144621900000000	0.000134909800000000	0.000125852000000000	0.000117413000000000	0.000109551500000000	0.000102224500000000	9.53944500000000e-05	8.90239000000000e-05	8.30752700000000e-05	7.75126900000000e-05	7.23130400000000e-05	6.74577800000000e-05	6.29284400000000e-05	5.87065200000000e-05	5.47702800000000e-05	5.10991800000000e-05	4.76765400000000e-05	4.44856700000000e-05	4.15099400000000e-05	3.87332400000000e-05	3.61420300000000e-05	3.37235200000000e-05	3.14648700000000e-05	2.93532600000000e-05	2.73757300000000e-05	2.55243300000000e-05	2.37937600000000e-05	2.21787000000000e-05	2.06738300000000e-05	1.92722600000000e-05	1.79664000000000e-05	1.67499100000000e-05	1.56164800000000e-05	1.45597700000000e-05	1.35738700000000e-05	1.26543600000000e-05	1.17972300000000e-05	1.09984400000000e-05	1.02539800000000e-05	9.55964600000000e-06	8.91204400000000e-06	8.30835800000000e-06	7.74576900000000e-06	7.22145600000000e-06	6.73247500000000e-06	6.27642300000000e-06	5.85130400000000e-06	5.45511800000000e-06	5.08586800000000e-06	4.74146600000000e-06	4.42023600000000e-06	4.12078300000000e-06	3.84171600000000e-06	3.58165200000000e-06	3.33912700000000e-06	3.11294900000000e-06	2.90212100000000e-06	2.70564500000000e-06	2.52252500000000e-06	2.35172600000000e-06	2.19241500000000e-06	2.04390200000000e-06	1.90549700000000e-06	1.77650900000000e-06	1.65621500000000e-06	1.54402200000000e-06	1.43944000000000e-06	1.34197700000000e-06	1.25114100000000e-06];
ybar = [3.91700000000000e-06	4.39358100000000e-06	4.92960400000000e-06	5.53213600000000e-06	6.20824500000000e-06	6.96500000000000e-06	7.81321900000000e-06	8.76733600000000e-06	9.83984400000000e-06	1.10432300000000e-05	1.23900000000000e-05	1.38864100000000e-05	1.55572800000000e-05	1.74429600000000e-05	1.95837500000000e-05	2.20200000000000e-05	2.48396500000000e-05	2.80412600000000e-05	3.15310400000000e-05	3.52152100000000e-05	3.90000000000000e-05	4.28264000000000e-05	4.69146000000000e-05	5.15896000000000e-05	5.71764000000000e-05	6.40000000000000e-05	7.23442100000000e-05	8.22122400000000e-05	9.35081600000000e-05	0.000106136100000000	0.000120000000000000	0.000134984000000000	0.000151492000000000	0.000170208000000000	0.000191816000000000	0.000217000000000000	0.000246906700000000	0.000281240000000000	0.000318520000000000	0.000357266700000000	0.000396000000000000	0.000433714700000000	0.000473024000000000	0.000517876000000000	0.000572218700000000	0.000640000000000000	0.000724560000000000	0.000825500000000000	0.000941160000000000	0.00106988000000000	0.00121000000000000	0.00136209100000000	0.00153075200000000	0.00172036800000000	0.00193532300000000	0.00218000000000000	0.00245480000000000	0.00276400000000000	0.00311780000000000	0.00352640000000000	0.00400000000000000	0.00454624000000000	0.00515932000000000	0.00582928000000000	0.00654616000000000	0.00730000000000000	0.00808650700000000	0.00890872000000000	0.00976768000000000	0.0106644300000000	0.0116000000000000	0.0125731700000000	0.0135827200000000	0.0146296800000000	0.0157150900000000	0.0168400000000000	0.0180073600000000	0.0192144800000000	0.0204539200000000	0.0217182400000000	0.0230000000000000	0.0242946100000000	0.0256102400000000	0.0269585700000000	0.0283512500000000	0.0298000000000000	0.0313108300000000	0.0328836800000000	0.0345211200000000	0.0362257100000000	0.0380000000000000	0.0398466700000000	0.0417680000000000	0.0437660000000000	0.0458426700000000	0.0480000000000000	0.0502436800000000	0.0525730400000000	0.0549805600000000	0.0574587200000000	0.0600000000000000	0.0626019700000000	0.0652775200000000	0.0680420800000000	0.0709110900000000	0.0739000000000000	0.0770160000000000	0.0802664000000000	0.0836668000000000	0.0872328000000000	0.0909800000000000	0.0949175500000000	0.0990458400000000	0.103367400000000	0.107884600000000	0.112600000000000	0.117532000000000	0.122674400000000	0.127992800000000	0.133452800000000	0.139020000000000	0.144676400000000	0.150469300000000	0.156461900000000	0.162717700000000	0.169300000000000	0.176243100000000	0.183558100000000	0.191273500000000	0.199418000000000	0.208020000000000	0.217119900000000	0.226734500000000	0.236857100000000	0.247481200000000	0.258600000000000	0.270184900000000	0.282293900000000	0.295050500000000	0.308578000000000	0.323000000000000	0.338402100000000	0.354685800000000	0.371698600000000	0.389287500000000	0.407300000000000	0.425629900000000	0.444309600000000	0.463394400000000	0.482939500000000	0.503000000000000	0.523569300000000	0.544512000000000	0.565690000000000	0.586965300000000	0.608200000000000	0.629345600000000	0.650306800000000	0.670875200000000	0.690842400000000	0.710000000000000	0.728185200000000	0.745463600000000	0.761969400000000	0.777836800000000	0.793200000000000	0.808110400000000	0.822496200000000	0.836306800000000	0.849491600000000	0.862000000000000	0.873810800000000	0.884962400000000	0.895493600000000	0.905443200000000	0.914850100000000	0.923734800000000	0.932092400000000	0.939922600000000	0.947225200000000	0.954000000000000	0.960256100000000	0.966007400000000	0.971260600000000	0.976022500000000	0.980300000000000	0.984092400000000	0.987418200000000	0.990312800000000	0.992811600000000	0.994950100000000	0.996710800000000	0.998098300000000	0.999112000000000	0.999748200000000	1	0.999856700000000	0.999304600000000	0.998325500000000	0.996898700000000	0.995000000000000	0.992600500000000	0.989742600000000	0.986444400000000	0.982724100000000	0.978600000000000	0.974083700000000	0.969171200000000	0.963856800000000	0.958134900000000	0.952000000000000	0.945450400000000	0.938499200000000	0.931162800000000	0.923457600000000	0.915400000000000	0.907006400000000	0.898277200000000	0.889204800000000	0.879781600000000	0.870000000000000	0.859861300000000	0.849392000000000	0.838622000000000	0.827581300000000	0.816300000000000	0.804794700000000	0.793082000000000	0.781192000000000	0.769154700000000	0.757000000000000	0.744754100000000	0.732422400000000	0.720003600000000	0.707496500000000	0.694900000000000	0.682219200000000	0.669471600000000	0.656674400000000	0.643844800000000	0.631000000000000	0.618155500000000	0.605314400000000	0.592475600000000	0.579637900000000	0.566800000000000	0.553961100000000	0.541137200000000	0.528352800000000	0.515632300000000	0.503000000000000	0.490468800000000	0.478030400000000	0.465677600000000	0.453403200000000	0.441200000000000	0.429080000000000	0.417036000000000	0.405032000000000	0.393032000000000	0.381000000000000	0.368918400000000	0.356827200000000	0.344776800000000	0.332817600000000	0.321000000000000	0.309338100000000	0.297850400000000	0.286593600000000	0.275624500000000	0.265000000000000	0.254763200000000	0.244889600000000	0.235334400000000	0.226052800000000	0.217000000000000	0.208161600000000	0.199548800000000	0.191155200000000	0.182974400000000	0.175000000000000	0.167223500000000	0.159646400000000	0.152277600000000	0.145125900000000	0.138200000000000	0.131500300000000	0.125024800000000	0.118779200000000	0.112769100000000	0.107000000000000	0.101476200000000	0.0961886400000000	0.0911229600000000	0.0862648500000000	0.0816000000000000	0.0771206400000000	0.0728255200000000	0.0687100800000000	0.0647697600000000	0.0610000000000000	0.0573962100000000	0.0539550400000000	0.0506737600000000	0.0475496500000000	0.0445800000000000	0.0417587200000000	0.0390849600000000	0.0365638400000000	0.0342004800000000	0.0320000000000000	0.0299626100000000	0.0280766400000000	0.0263293600000000	0.0247080500000000	0.0232000000000000	0.0218007700000000	0.0205011200000000	0.0192810800000000	0.0181206900000000	0.0170000000000000	0.0159037900000000	0.0148371800000000	0.0138106800000000	0.0128347800000000	0.0119200000000000	0.0110683100000000	0.0102733900000000	0.00953331100000000	0.00884615700000000	0.00821000000000000	0.00762378100000000	0.00708542400000000	0.00659147600000000	0.00613848500000000	0.00572300000000000	0.00534305900000000	0.00499579600000000	0.00467640400000000	0.00438007500000000	0.00410200000000000	0.00383845300000000	0.00358909900000000	0.00335421900000000	0.00313409300000000	0.00292900000000000	0.00273813900000000	0.00255987600000000	0.00239324400000000	0.00223727500000000	0.00209100000000000	0.00195358700000000	0.00182458000000000	0.00170358000000000	0.00159018700000000	0.00148400000000000	0.00138449600000000	0.00129126800000000	0.00120409200000000	0.00112274400000000	0.00104700000000000	0.000976589600000000	0.000911108800000000	0.000850133200000000	0.000793238400000000	0.000740000000000000	0.000690082700000000	0.000643310000000000	0.000599496000000000	0.000558454700000000	0.000520000000000000	0.000483913600000000	0.000450052800000000	0.000418345200000000	0.000388718400000000	0.000361100000000000	0.000335383500000000	0.000311440400000000	0.000289165600000000	0.000268453900000000	0.000249200000000000	0.000231301900000000	0.000214685600000000	0.000199288400000000	0.000185047500000000	0.000171900000000000	0.000159778100000000	0.000148604400000000	0.000138301600000000	0.000128792500000000	0.000120000000000000	0.000111859500000000	0.000104322400000000	9.73356000000000e-05	9.08458700000000e-05	8.48000000000000e-05	7.91466700000000e-05	7.38580000000000e-05	6.89160000000000e-05	6.43026700000000e-05	6.00000000000000e-05	5.59818700000000e-05	5.22256000000000e-05	4.87184000000000e-05	4.54474700000000e-05	4.24000000000000e-05	3.95610400000000e-05	3.69151200000000e-05	3.44486800000000e-05	3.21481600000000e-05	3.00000000000000e-05	2.79912500000000e-05	2.61135600000000e-05	2.43602400000000e-05	2.27246100000000e-05	2.12000000000000e-05	1.97785500000000e-05	1.84528500000000e-05	1.72168700000000e-05	1.60645900000000e-05	1.49900000000000e-05	1.39872800000000e-05	1.30515500000000e-05	1.21781800000000e-05	1.13625400000000e-05	1.06000000000000e-05	9.88587700000000e-06	9.21730400000000e-06	8.59236200000000e-06	8.00913300000000e-06	7.46570000000000e-06	6.95956700000000e-06	6.48799500000000e-06	6.04869900000000e-06	5.63939600000000e-06	5.25780000000000e-06	4.90177100000000e-06	4.56972000000000e-06	4.26019400000000e-06	3.97173900000000e-06	3.70290000000000e-06	3.45216300000000e-06	3.21830200000000e-06	3.00030000000000e-06	2.79713900000000e-06	2.60780000000000e-06	2.43122000000000e-06	2.26653100000000e-06	2.11301300000000e-06	1.96994300000000e-06	1.83660000000000e-06	1.71223000000000e-06	1.59622800000000e-06	1.48809000000000e-06	1.38731400000000e-06	1.29340000000000e-06	1.20582000000000e-06	1.12414300000000e-06	1.04800900000000e-06	9.77057800000000e-07	9.10930000000000e-07	8.49251300000000e-07	7.91721200000000e-07	7.38090400000000e-07	6.88109800000000e-07	6.41530000000000e-07	5.98089500000000e-07	5.57574600000000e-07	5.19808000000000e-07	4.84612300000000e-07	4.51810000000000e-07];
zbar = [0.000606100000000000	0.000680879200000000	0.000765145600000000	0.000860012400000000	0.000966592800000000	0.00108600000000000	0.00122058600000000	0.00137272900000000	0.00154357900000000	0.00173428600000000	0.00194600000000000	0.00217777700000000	0.00243580900000000	0.00273195300000000	0.00307806400000000	0.00348600000000000	0.00397522700000000	0.00454088000000000	0.00515832000000000	0.00580290700000000	0.00645000100000000	0.00708321600000000	0.00774548800000000	0.00850115200000000	0.00941454400000000	0.0105499900000000	0.0119658000000000	0.0136558700000000	0.0155880500000000	0.0177301500000000	0.0200500100000000	0.0225113600000000	0.0252028800000000	0.0282797200000000	0.0318970400000000	0.0362100000000000	0.0414377100000000	0.0475037200000000	0.0541198800000000	0.0609980300000000	0.0678500100000000	0.0744863200000000	0.0813615600000000	0.0891536400000000	0.0985404800000000	0.110200000000000	0.124613300000000	0.141701700000000	0.161303500000000	0.183256800000000	0.207400000000000	0.233692100000000	0.262611400000000	0.294774600000000	0.330798500000000	0.371300000000000	0.416209100000000	0.465464200000000	0.519694800000000	0.579530300000000	0.645600000000000	0.718483800000000	0.796713300000000	0.877845900000000	0.959439000000000	1.03905010000000	1.11536730000000	1.18849710000000	1.25812330000000	1.32392960000000	1.38560000000000	1.44263520000000	1.49480350000000	1.54219030000000	1.58488070000000	1.62296000000000	1.65640480000000	1.68529590000000	1.70987450000000	1.73038210000000	1.74706000000000	1.76004460000000	1.76962330000000	1.77626370000000	1.78043340000000	1.78260000000000	1.78296820000000	1.78169980000000	1.77919820000000	1.77586710000000	1.77211000000000	1.76825890000000	1.76403900000000	1.75894380000000	1.75246630000000	1.74410000000000	1.73355950000000	1.72085810000000	1.70593690000000	1.68873720000000	1.66920000000000	1.64752870000000	1.62341270000000	1.59602230000000	1.56452800000000	1.52810000000000	1.48611140000000	1.43952150000000	1.38987990000000	1.33873620000000	1.28764000000000	1.23742230000000	1.18782430000000	1.13876110000000	1.09014800000000	1.04190000000000	0.994197600000000	0.947347300000000	0.901453100000000	0.856619300000000	0.812950100000000	0.770517300000000	0.729444800000000	0.689913600000000	0.652104900000000	0.616200000000000	0.582328600000000	0.550416200000000	0.520337600000000	0.491967300000000	0.465180000000000	0.439924600000000	0.416183600000000	0.393882200000000	0.372945900000000	0.353300000000000	0.334857800000000	0.317552100000000	0.301337500000000	0.286168600000000	0.272000000000000	0.258817100000000	0.246483800000000	0.234771800000000	0.223453300000000	0.212300000000000	0.201169200000000	0.190119600000000	0.179225400000000	0.168560800000000	0.158200000000000	0.148138300000000	0.138375800000000	0.128994200000000	0.120075100000000	0.111700000000000	0.103904800000000	0.0966674800000000	0.0899827200000000	0.0838453100000000	0.0782499900000000	0.0732089900000000	0.0686781600000000	0.0645678400000000	0.0607883500000000	0.0572500100000000	0.0539043500000000	0.0507466400000000	0.0477527600000000	0.0448985900000000	0.0421600000000000	0.0395072800000000	0.0369356400000000	0.0344583600000000	0.0320887200000000	0.0298400000000000	0.0277118100000000	0.0256944400000000	0.0237871600000000	0.0219892500000000	0.0203000000000000	0.0187180500000000	0.0172403600000000	0.0158636400000000	0.0145846100000000	0.0134000000000000	0.0123072300000000	0.0113018800000000	0.0103779200000000	0.00952930600000000	0.00874999900000000	0.00803520000000000	0.00738160000000000	0.00678540000000000	0.00624280000000000	0.00574999900000000	0.00530360000000000	0.00489980000000000	0.00453420000000000	0.00420240000000000	0.00390000000000000	0.00362320000000000	0.00337060000000000	0.00314140000000000	0.00293480000000000	0.00274999900000000	0.00258520000000000	0.00243860000000000	0.00230940000000000	0.00219680000000000	0.00210000000000000	0.00201773300000000	0.00194820000000000	0.00188980000000000	0.00184093300000000	0.00180000000000000	0.00176626700000000	0.00173780000000000	0.00171120000000000	0.00168306700000000	0.00165000100000000	0.00161013300000000	0.00156440000000000	0.00151360000000000	0.00145853300000000	0.00140000000000000	0.00133666700000000	0.00127000000000000	0.00120500000000000	0.00114666700000000	0.00110000000000000	0.00106880000000000	0.00104940000000000	0.00103560000000000	0.00102120000000000	0.00100000000000000	0.000968640000000000	0.000929920000000000	0.000886880000000000	0.000842560000000000	0.000800000000000000	0.000760960000000000	0.000723680000000000	0.000685920000000000	0.000645440000000000	0.000600000000000000	0.000547866700000000	0.000491600000000000	0.000435400000000000	0.000383466700000000	0.000340000000000000	0.000307253300000000	0.000283160000000000	0.000265440000000000	0.000251813300000000	0.000240000000000000	0.000229546700000000	0.000220640000000000	0.000211960000000000	0.000202186700000000	0.000190000000000000	0.000174213300000000	0.000155640000000000	0.000135960000000000	0.000116853300000000	0.000100000000000000	8.61333300000000e-05	7.46000000000000e-05	6.50000000000000e-05	5.69333300000000e-05	4.99999900000000e-05	4.41600000000000e-05	3.94800000000000e-05	3.57200000000000e-05	3.26400000000000e-05	3.00000000000000e-05	2.76533300000000e-05	2.55600000000000e-05	2.36400000000000e-05	2.18133300000000e-05	2.00000000000000e-05	1.81333300000000e-05	1.62000000000000e-05	1.42000000000000e-05	1.21333300000000e-05	1.00000000000000e-05	7.73333300000000e-06	5.40000000000000e-06	3.20000000000000e-06	1.33333300000000e-06	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0];

WL_xyz = 360:1:830;     % domínio das curvas originais

% Interpolate x̄(λ), ȳ(λ), z̄(λ) to match the spectral data resolution (WL_interp)
xbar_interp = interp1(WL_xyz, xbar, WL_interp, 'linear', 0);
ybar_interp = interp1(WL_xyz, ybar, WL_interp, 'linear', 0);
zbar_interp = interp1(WL_xyz, zbar, WL_interp, 'linear', 0);

% Compute the Tristimulus Values (X, Y, Z)
X = sum(SPD_interp .* xbar_interp);
Y = sum(SPD_interp .* ybar_interp);
Z = sum(SPD_interp .* zbar_interp);

% Compute CIE 1931 Chromaticity Coordinates
x = X / (X + Y + Z);
y = Y / (X + Y + Z);

% Compute CIE 1976 (u, u′) Coordinates
u = (4 * x) / (-2 * x + 12 * y + 3);
v = (6 * y) / (-2 * x + 12 * y + 3);
v2 = (9 * y) / (-2 * x + 12 * y + 3);  % u′v′ space for CCT calculation

% Correlated Color Temperature (CCT) using u′v′ distance to Planckian locus
[CCT_table, u_locus, v_locus] = planckian_locus();  % Reference locus data

distances = sqrt((u_locus - u).^2 + (v_locus - v2).^2);
[~, idx] = min(distances);                          % Find closest match
CCT = CCT_table(idx);                               % Estimated CCT [K]

% Peak Wavelength
[~, idx] = max(SPD);        % Index of original (not interpolated) peak
PeakWL = WL_interp(idx);    % Wavelength of the peak

% Full Width at Half Maximum (FWHM)
[max_val, max_idx] = max(SPD_interp);
half_max = max_val / 2;

% Find left and right bounds where spectrum crosses half maximum
left_idx = find(SPD_interp(1:max_idx) < half_max, 1, 'last');
right_idx = max_idx - 1 + find(SPD_interp(max_idx:end) < half_max, 1, 'first');

% Linear interpolation for more accurate crossing points
lambda_left = interp1(SPD_interp(left_idx:left_idx+1), WL_interp(left_idx:left_idx+1), half_max);
lambda_right = interp1(SPD_interp(right_idx-1:right_idx), WL_interp(right_idx-1:right_idx), half_max);
FWHM = lambda_right - lambda_left;  % FWHM in nanometers

% Convert from XYZ to linear RGB using the sRGB transformation matrix
M = [ 3.2406, -1.5372, -0.4986;
     -0.9689,  1.8758,  0.0415;
      0.0557, -0.2040,  1.0570 ];

RGB_linear = M * [X; Y; Z];

% Clamp negative values to zero (non-physical)
RGB_linear = max(RGB_linear, 0);

% Normalize RGB to obtain relative ratios
RGB_sum = sum(RGB_linear);
if RGB_sum > 0
    RGB_ratio = RGB_linear / RGB_sum;
else
    RGB_ratio = [0; 0; 0];  % if all values are zero, avoid division by zero
end

% Extract individual components
R = RGB_ratio(1);
G = RGB_ratio(2);
B = RGB_ratio(3);

% DISPLAY RESULTS
% -------------------------------------------------------------------------------------

fprintf('-------------------------------------');
fprintf('\nABSOLUTE RESULTS:\n');
fprintf('Photon Flux (PF): %.4f umol/s\n', PF_abs);
fprintf('Photosynthetic Photon Flux (PPF): %.4f umol/s\n', PPF_abs);
fprintf('Radiant Power: %.4f W\n', Wrad_abs);
fprintf('Luminous Flux: %.2f lm\n', FL_abs);

fprintf('-------------------------------------');
fprintf('\nCONVERSION RATIOS:\n');
fprintf('FL / PF: %.4f lm/(umol/s)\n', FL_PF);
fprintf('FL / PPF: %.4f lm/(umol/s)\n', FL_PPF);
fprintf('FL / Radiant Power: %.4f lm/W\n', FL_Wrad);
fprintf('Radiant Power / PPF: %.4f W/(umol/s)\n', Wrad_PPF);
fprintf('Radiant Power / PF: %.4f W/(umol/s)\n', Wrad_PF);
fprintf('PF / PPF: %.4f\n', PF_PPF);

fprintf('-------------------------------------');
fprintf('\nLUMINOTECNICAL CARACTERISTICS:\n');
fprintf('x: %.4f\n', x);
fprintf('y: %.4f\n', y);
fprintf('u: %.4f\n', u);
fprintf('v: %.4f\n', v);
fprintf('v`: %.4f\n', v2);
fprintf('CCT: %.4f K\n', CCT);
fprintf('Peak Wevelenght: %.4f nm\n', PeakWL);
fprintf('Half Bandwidth:: %.4f nm\n', FWHM);
fprintf('-------------------------------------');
fprintf('\nRGB Ratios:\n');
fprintf('R: %.3f\n', R);
fprintf('G: %.3f\n', G);
fprintf('B: %.3f\n', B);


%% planckian_locus.m
function [CCT_table, u_locus, v_locus] = planckian_locus()
    data = [...
        1466.00	0.362370281	0.54028434
        1496.00	0.358293619	0.540460518
        1527.00	0.354254734	0.540600578
        1558.00	0.350256304	0.540703454
        1590.00	0.346300947	0.540768128
        1622.00	0.342391206	0.540793634
        1655.00	0.338529525	0.540779073
        1689.00	0.334718231	0.540723621
        1724.00	0.330959509	0.540626544
        1759.00	0.327255373	0.540487203
        1795.00	0.323607644	0.540305075
        1831.00	0.320017905	0.540079775
        1869.00	0.316487138	0.539811696
        1907.00	0.31301547	0.539502414
        1946.00	0.309602636	0.539152682
        1985.00	0.30624822	0.53875901
        2026.00	0.302951531	0.538316987
        2067.00	0.299713499	0.537826214
        2110.00	0.296536265	0.537289578
        2153.00	0.293420943	0.536709803
        2196.00	0.290365636	0.536087709
        2241.00	0.28736733	0.535423905
        2287.00	0.284425353	0.534718478
        2334.00	0.281542493	0.533970722
        2381.00	0.278721538	0.533180003
        2430.00	0.275962361	0.532346691
        2480.00	0.273262104	0.531472107
        2530.00	0.270617293	0.53055786
        2582.00	0.268027407	0.529604958
        2634.00	0.265494532	0.528613917
        2688.00	0.263020666	0.527585427
        2743.00	0.260606198	0.526520282
        2799.00	0.258249208	0.525419355
        2856.00	0.255946992	0.524283741
        2914.00	0.25369697	0.523114772
        2974.00	0.251499561	0.52191404
        3035.00	0.249355872	0.520683428
        3097.00	0.247266773	0.519425127
        3160.00	0.245232294	0.518140811
        3224.00	0.243251125	0.516830961
        3290.00	0.241321338	0.515496044
        3357.00	0.239440434	0.514136639
        3426.00	0.237606842	0.512754035
        3496.00	0.235820856	0.511350606
        3567.00	0.234082682	0.509929127
        3640.00	0.232392234	0.508492743
        3714.00	0.230749141	0.507043857
        3790.00	0.229152831	0.505581042
        3867.00	0.227602388	0.504101753
        3946.00	0.226096476	0.502603121
        4027.00	0.224633309	0.501082017
        4109.00	0.223211517	0.499541063
        4193.00	0.221830784	0.497993136
        4278.00	0.220490618	0.49645362
        4366.00	0.219190198	0.494939756
        4455.00	0.217928341	0.493470798
        4546.00	0.216703885	0.49205862
        4638.00	0.215516531	0.490688141
        4733.00	0.214365931	0.489336917
        4830.00	0.213251458	0.487979453
        4928.00	0.212172167	0.486586922
        5029.00	0.211126777	0.485127087
        5131.00	0.210114206	0.483582317
        5236.00	0.209134087	0.481966854
        5343.00	0.208185912	0.480300605
        5452.00	0.207268904	0.478606196
        5563.00	0.206381989	0.476909217
        5677.00	0.205523762	0.475238477
        5793.00	0.20469257	0.473624196
        5911.00	0.203887697	0.472075769
        6031.00	0.203109033	0.47058752
        6155.00	0.202356299	0.46915242
        6280.00	0.201629018	0.467762204
        6408.00	0.200926489	0.466407246
        6539.00	0.200247767	0.465076449
        6673.00	0.199591634	0.463757096
        6809.00	0.198956913	0.462438068
        6948.00	0.198343372	0.46111892
        7090.00	0.197750894	0.459801821
        7234.00	0.197179212	0.458489144
        7382.00	0.196627896	0.457183476
        7532.00	0.196096335	0.45588764
        7686.00	0.195583716	0.4546047
        7843.00	0.195089003	0.453337989
        8003.00	0.194610914	0.452091128
        8166.00	0.194148232	0.450867366
        8333.00	0.193700788	0.449667576
        8503.00	0.19326861	0.44849193
        8677.00	0.192851633	0.447340445
        8854.00	0.19244969	0.446212959
        9034.00	0.1920625	0.445109123
        9219.00	0.191689651	0.444028362
        9407.00	0.191330594	0.442969866
        9599.00	0.190984622	0.441932558
        9795.00	0.190650854	0.44091506
        9995.00	0.190328224	0.439915676
        10199.00	0.190015689	0.438932802
        10407.00	0.189713058	0.437966534
        10619.00	0.189420344	0.437017415
        10836.00	0.189137497	0.436085927
        11057.00	0.1888644	0.435172479
        11283.00	0.188600864	0.43427739
        11513.00	0.188346652	0.433400793
        11748.00	0.188101459	0.43254266
        11988.00	0.187864885	0.431702822
        12232.00	0.187636424	0.430880958
        12482.00	0.187415454	0.430076579
        12737.00	0.187201344	0.429289124
        12997.00	0.186993935	0.428518487
        13262.00	0.186793199	0.427764621
        13533.00	0.186599059	0.427027361
        13809.00	0.186411388	0.426306395
        14091.00	0.186230003	0.425601263
        14378.00	0.186054655	0.42491133
        14672.00	0.185885136	0.424236174
        14971.00	0.185721351	0.423575873
        15277.00	0.185563174	0.422930469
        15588.00	0.185410427	0.422299905
        15906.00	0.185262874	0.421684013
        16231.00	0.185120218	0.421082499
        16562.00	0.184982091	0.420494933
        16900.00	0.18484808	0.419920775
        17245.00	0.184718019	0.419359833
        17597.00	0.184591904	0.418812119
        17956.00	0.184469706	0.418277558
        18323.00	0.184351368	0.417755973
        18697.00	0.1842368	0.417247077
        19078.00	0.184125877	0.416750456
        19468.00	0.184018434	0.416265558
        19865.00	0.183914263	0.41579168
        20270.00	0.183813124	0.41532801
        20684.00	0.183714924	0.414874296
        21106.00	0.183619668	0.41443068
        21537.00	0.183527349	0.413997252
        21976.00	0.183437935	0.41357405
        22425.00	0.183351376	0.41316104
        22883.00	0.183267594	0.412758114
        23349.00	0.183186485	0.412365081
        23826.00	0.183107914	0.41198166
        24312.00	0.183031712	0.411607464
        24808.00	0.182957673	0.411241991
        25315.00	0.182885563	0.410884655
        25831.00	0.182815288	0.410535246
        26359.00	0.182746868	0.41019387
        26896.00	0.182680315	0.409860594
        27445.00	0.182615632	0.409535436
        28005.00	0.182552808	0.409218363
        28577.00	0.182491821	0.408909282
        29160.00	0.18243263	0.408608034
        29755.00	0.182375181	0.408314384
        30363.00	0.1823194	0.408028016
        30982.00	0.182265193	0.407748522
        31614.00	0.182212442	0.407475398
        32260.00	0.182161007	0.407208023
        32918.00	0.182110717	0.406945662
        33590.00	0.182061377	0.406687455
        34275.00	0.182012879	0.406432943
        34975.00	0.181965269	0.406182345
        35689.00	0.181918605	0.405935937
        36417.00	0.181872942	0.405693998
        37160.00	0.18182834	0.405456803
        37919.00	0.181784855	0.405224634
        38692.00	0.181742544	0.404997768
        39482.00	0.181701466	0.404776485
        40288.00	0.181661675	0.404561058
        41110.00	0.181623227	0.404351757
        41949.00	0.181586176	0.404148851
        42805.00	0.181550573	0.403952594
        43679.00	0.181516469	0.403763237
        44570.00	0.181483911	0.40358102
        45480.00	0.181452943	0.403406165
        46408.00	0.181423605	0.403238885
        47355.00	0.181395935	0.403079367
        48321.00	0.181369965	0.402927788
        49307.00	0.18134572	0.402784289
        50314.00	0.181323222	0.402648992
        51341.00	0.181302483	0.402521985
        52388.00	0.181283509	0.402403319
        53457.00	0.181266297	0.40229301
        54548.00	0.181250834	0.402191025
        55662.00	0.181237096	0.402097286
        56798.00	0.181225048	0.402011657
        57957.00	0.18121464	0.401933943
        59140.00	0.181205808	0.401863883
        60346.00	0.181198472	0.401801136
        61578.00	0.181192534	0.401745285
        62835.00	0.181187876	0.401695824
        64117.00	0.181184358	0.401652141
        65426.00	0.181181817	0.401613522
        66761.00	0.181180066	0.401579133
        68123.00	0.181178885	0.40154801
        69514.00	0.181178029	0.401519045
        70932.00	0.181177214	0.401490978
        72380.00	0.181176124	0.401462384
        73857.00	0.181174401	0.401431647
        75364.00	0.181171643	0.401396961
        76902.00	0.181167404	0.401356296
        78472.00	0.181161185	0.401307392
        80073.00	0.181152433	0.401247734
        81707.00	0.181140534	0.401174529
        83375.00	0.181124811	0.401084688
        85076.00	0.181104517	0.4009748
        86813.00	0.181078829	0.400841097
        88584.00	0.181046842	0.400679444
        90392.00	0.181007564	0.400485291
        92237.00	0.180959908	0.400253651
        94119.00	0.180902684	0.399979056
        96040.00	0.180834592	0.399655535
        98000.00	0.180754213	0.399276558
        100000.00	0.18066	0.398835
        ...
        ];

    CCT_table = data(:,1); % [Kelvin]
    u_locus = data(:,2);   % u'
    v_locus = data(:,3);   % v'
end
 